<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.suitecare.suitecare.api.mate_resume.mapper.MateResumeMapper">

    <!--<insert id="createMateResume" useGeneratedKeys="true" keyProperty="mateResumeDTO.id">-->
    <insert id="createMateResume">
        INSERT INTO mateResume(id, profile_picture_filename, contact_time_start, contact_time_end, introduction, desired_wage)
        VALUES (#{id}, #{mateResumeDTO.profilePictureFilename}, #{mateResumeDTO.contactTimeStart}, #{mateResumeDTO.contactTimeEnd}, #{mateResumeDTO.introduction}, #{mateResumeDTO.desiredWage});
    </insert>
    
    <select id="findResumeById" resultType="MateResumeDTO">
        SELECT  id,
                profile_picture_filename as profilePictureFilename,
                introduction,
                contact_time_start as contactTimeStart,
                contact_time_end as contactTimeEnd,
                desired_wage as desiredWage
        FROM materesume
        WHERE id = #{id};
    </select>

    <select id="isPresentResume">
        SELECT id FROM materesume WHERE member_id = #{id}
    </select>

    <select id="getSearchedMate" resultType="SearchedMateResponseDTO">
        WITH resume	AS (
            SELECT r.member_id, profile_picture_filename, introduction, contact_time_start, contact_time_end, desired_wage,
            GROUP_CONCAT(distinct loc.name) as location,
            GROUP_CONCAT(distinct service.name) as mainservice
            FROM materesume r
            JOIN location loc ON r.member_id = loc.member_id
            JOIN mainservice service ON r.member_id = service.member_id
            GROUP BY r.member_id, profile_picture_filename, introduction, contact_time_start, contact_time_end, desired_wage
        )

        SELECT member_id, profile_picture_filename, introduction, contact_time_start, contact_time_end, desired_wage, location, mainservice, name, gender, birthday
        FROM resume
        JOIN suitemember ON id = member_id

        WHERE
        desired_wage BETWEEN
            <foreach collection="wage" item="it" separator="and">
                #{it}
            </foreach>

        <if test="search_name != null">
            AND name LIKE CONCAT('%', #{search_name}, '%')
        </if>

        <if test="gender != null and gender.length == 1">
            AND gender =
            <foreach collection="gender" item="it">
                #{it}
            </foreach>
        </if>

        <if test = "age != null">
            AND TRUNCATE((to_days(NOW()) - to_days(birthday)) / 365, -1) IN
                <foreach collection="age" item="it" separator="," open="(" close=")">
                    #{it}
                </foreach>
        </if>

        <if test="location != null">
            AND
            <foreach collection="location" item="it" index="idx" separator="or" open="(" close=")">
                location LIKE CONCAT('%', #{it}, '%')
            </foreach>
        </if>

        <if test="service != null">
            AND
            <foreach collection="service" item="it" index="idx" separator="or" open="(" close=")">
                mainservice LIKE CONCAT('%', #{it}, '%')
            </foreach>
        </if>
    </select>

    <update id="updateResume">
        UPDATE MateResume
        <set>
            <if test="resumeRequestDTO.profilePictureFilename != null">profile_picture_filename = #{resumeRequestDTO.profilePictureFilename},</if>
            <if test="resumeRequestDTO.contactTimeStart != null">contact_time_start = #{resumeRequestDTO.contactTimeStart},</if>
            <if test="resumeRequestDTO.contactTimeEnd != null">contact_time_end = #{resumeRequestDTO.contactTimeEnd},</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>