<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.suitecare.suitecare.api.reservation.mapper.ReservationMapper">

    <!-- 예약 등록 프론트url=(/family/reservation) -->
    <insert id="createReservation" parameterType="ReservationRequestDTO" useGeneratedKeys="true" keyProperty="id">
        insert into Reservation (patient_id, location, postcode, road_address, jibun_address, address_detail, status, start_date, end_date, start_time, end_time, wage, create_at, update_at)
        values (#{patient_id}, #{location}, #{postcode}, #{road_address}, #{jibun_address}, #{address_detail}, "P", #{start_date}, #{end_date}, #{start_time}, #{end_time}, #{wage}, sysdate(), sysdate())
    </insert>

    <!-- 예약 등록(요일) 프론트url=(/family/reservation) -->
    <insert id="createDayOfReservation" parameterType="com.suitecare.suitecare.api.reservation.domain.DayOfReservation">
        insert into DayOfReservation (reservation_id, day)
        values (#{reservation_id}, #{day})
    </insert>

    <select id="getSearchedReservation" parameterType="SearchedReservationRequestDTO" resultType="SearchedReservationResponseDTO">
        SELECT reservation.id, patient_id, gender, birthday, diagnosis_name, location, substring_index(road_address, " ", 2) as road_address, wage, start_date, end_date, start_time, end_time, GROUP_CONCAT(day) as day
        FROM reservation
        JOIN patient as p ON p.id = reservation.patient_id
        JOIN dayofreservation as d ON d.reservation_id = reservation.id
        WHERE status = 'P' AND start_date > current_date()
        AND wage between
        <foreach collection="wage" item="it" separator="and">
            #{it}
        </foreach>
        <if test="search_input neq ''">
            AND diagnosis_name like '%${search_input}%'
        </if>
        <if test="location != null">
            AND SUBSTRING(road_address, 4, 3) in
            <foreach collection="location" item="it" open="(" close=")" separator=",">
                #{it}
            </foreach>
        </if>
        <if test="gender != null and gender.length == 1">
            AND gender =
            <foreach collection="gender" item="it">
                #{it}
            </foreach>
        </if>
        GROUP BY reservation.id;
    </select>

    <select id="getReservationListById" resultType="PendingReservationResponseDTO">
        SELECT r.id reservation_id, patient_id, start_date, end_date
        FROM reservation r, patient p
        WHERE family_id = #{id} AND r.patient_id = p.id AND now() <![CDATA[<]]> start_date AND status = 'p';
    </select>

    <select id="getReservationInfoById" resultType="ReservationInfoResponseDTO">
        SELECT location, road_address, address_detail, wage, start_time, end_time, group_concat(day) weekday
        FROM reservation r, dayofreservation d
        WHERE r.id = #{reservation_id} AND d.reservation_id = r.id
        GROUP BY d.reservation_id;
    </select>

    <select id="getApplicantList" resultType="ApplicantInfoResponseDTO">
        select name, birthday, profile_picture_filename, introduction, contact_time_start, contact_time_end, desired_wage, group_concat(distinct main_service_name) mainservice, group_concat(distinct location_name) location
        from suitemember s, suitemateprofile p, mainservice m, location l
        where p.family_id in (select member_id from applicantofreservation where reservation_id = #{reservation_id})
        and s.id = p.family_id and p.id = m.mate_id and p.id = l.mate_id
        group by m.mate_id;
    </select>
</mapper>